steps:

# Pull images for faster builds

- name: 'gcr.io/cloud-builders/docker'
  id: pull-python
  waitFor: ['-']
  entrypoint: bash
  args: ['-c', 'docker pull gcr.io/$PROJECT_ID/python || true']

- name: 'gcr.io/cloud-builders/docker'
  id: pull-node
  waitFor: ['-']
  entrypoint: bash
  args: ['-c', 'docker pull gcr.io/$PROJECT_ID/node || true']

- name: 'gcr.io/cloud-builders/docker'
  id: pull-nginx
  waitFor: ['-']
  entrypoint: bash
  args: ['-c', 'docker pull gcr.io/$PROJECT_ID/nginx || true']

# Setup environment variables

- name: 'gcr.io/cloud-builders/gcloud'
  id: env
  waitFor: ['-']
  args:
  - kms
  - decrypt
  - '--ciphertext-file=deploy/$TAG_NAME.env.enc'
  - --plaintext-file=.env
  - --location=global
  - --keyring=linksight
  - --key=linksight

# Build images

- name: 'gcr.io/cloud-builders/docker'
  id: build-python
  waitFor: ['env', 'pull-python']
  args:
  - build
  - -f=deploy/Dockerfile.python
  - '-t=gcr.io/$PROJECT_ID/python'
  - '--cache-from=gcr.io/$PROJECT_ID/python'
  - .

- name: 'gcr.io/cloud-builders/docker'
  id: build-node
  waitFor: ['pull-node']
  args:
  - build
  - -f=deploy/Dockerfile.node
  - --build-arg
  - 'PUBLIC_URL=https://$_HOST'
  - '-t=gcr.io/$PROJECT_ID/node'
  - '--cache-from=gcr.io/$PROJECT_ID/node'
  - .

- name: 'gcr.io/cloud-builders/docker'
  id: build-nginx
  waitFor: ['pull-nginx', 'build-python', 'build-node']
  args:
  - build
  - -f=deploy/Dockerfile.nginx
  - '-t=gcr.io/$PROJECT_ID/nginx'
  - '--cache-from=gcr.io/$PROJECT_ID/nginx'
  - .

# Push images to GCR

- name: 'gcr.io/cloud-builders/docker'
  id: push-python
  waitFor: ['build-python']
  args: ['push', 'gcr.io/$PROJECT_ID/python']

- name: 'gcr.io/cloud-builders/docker'
  id: push-nginx
  waitFor: ['build-nginx']
  args: ['push', 'gcr.io/$PROJECT_ID/nginx']

# Decrypt docker certs

- name: 'gcr.io/cloud-builders/gcloud'
  id: ca
  waitFor: ['-']
  args:
  - kms
  - decrypt
  - --ciphertext-file=deploy/ca.pem.enc
  - --plaintext-file=ca.pem
  - --location=global
  - --keyring=linksight
  - --key=linksight

- name: 'gcr.io/cloud-builders/gcloud'
  id: cert
  waitFor: ['-']
  args:
  - kms
  - decrypt
  - --ciphertext-file=deploy/cert.pem.enc
  - --plaintext-file=cert.pem
  - --location=global
  - --keyring=linksight
  - --key=linksight

- name: 'gcr.io/cloud-builders/gcloud'
  id: key
  waitFor: ['-']
  args:
  - kms
  - decrypt
  - --ciphertext-file=deploy/key.pem.enc
  - --plaintext-file=key.pem
  - --location=global
  - --keyring=linksight
  - --key=linksight

# Update containers

- name: 'docker/compose:1.22.0'
  waitFor: ['push-python', 'push-nginx', 'ca', 'cert', 'key']
  args: ['-p', 'linksight', '-f', 'deploy/docker-compose.yml', 'pull']
  env:
  - 'DOCKER_HOST=$_HOST:2376'
  - DOCKER_TLS_VERIFY=1
  - DOCKER_CERT_PATH=.

- name: 'docker/compose:1.22.0'
  waitFor: ['push-python', 'push-nginx', 'ca', 'cert', 'key']
  args: ['-p', 'linksight', '-f', 'deploy/docker-compose.yml', 'up', '-d']
  env:
  - 'DOCKER_HOST=$_HOST:2376'
  - DOCKER_TLS_VERIFY=1
  - DOCKER_CERT_PATH=.

# Other build config

images:
- 'gcr.io/$PROJECT_ID/python'
- 'gcr.io/$PROJECT_ID/node'
- 'gcr.io/$PROJECT_ID/nginx'

substitutions:
  _HOST: linksight.thinkingmachin.es

